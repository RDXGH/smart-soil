<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Soil Monitoring Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 {
      font-size: 2.2rem;
      background: linear-gradient(45deg,#667eea,#764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(300px,1fr));
      gap: 25px;
      margin-bottom: 30px;
    }
    .sensor-card {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      position: relative;
    }
    .sensor-header { display: flex; align-items: center; margin-bottom: 15px; }
    .sensor-icon {
      width: 45px; height: 45px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: white; font-size: 1.3rem; margin-right: 12px;
    }
    .moisture-card .sensor-icon { background: #3498db; }
    .ph-card .sensor-icon { background: #e74c3c; }
    .temp-card .sensor-icon { background: #f39c12; }
    .npk-card .sensor-icon { background: #27ae60; }
    .sensor-title { font-weight: 600; }
    .sensor-value { font-size: 2rem; font-weight: bold; margin: 10px 0; }
    .sensor-status { font-size: 0.9rem; margin-top: 8px; }
    .status-good { color: #27ae60; }
    .status-warning { color: #f39c12; }
    .status-critical { color: #e74c3c; }
    .input-box {
      width: 100%; padding: 8px; border-radius: 8px;
      border: 1px solid #ccc; margin-top: 5px; font-size: 1rem;
    }
    .refresh-btn {
      background: linear-gradient(45deg,#667eea,#764ba2);
      color: #fff; border: none; padding: 12px 25px;
      border-radius: 25px; font-weight: 600;
      cursor: pointer; display: block; margin: 15px auto;
      box-shadow: 0 4px 15px rgba(102,126,234,0.4);
    }
    .ai-card {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    .recommendation-item {
      background: #fff; padding: 12px;
      border-radius: 10px; margin-bottom: 10px;
      border-left: 4px solid #27ae60;
    }
    .recommendation-title { font-weight: 600; margin-bottom: 4px; }
    .recommendation-desc { font-size: 0.9rem; color: #555; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üå± Smart Soil Monitoring Dashboard</h1>
      <p>Real-time soil analysis with AI-powered crop suggestions</p>
    </div>

    <div class="dashboard-grid">
      <!-- Moisture Sensor -->
      <div class="sensor-card moisture-card">
        <div class="sensor-header">
          <div class="sensor-icon">üíß</div>
          <div class="sensor-title">Soil Moisture</div>
        </div>
        <div class="sensor-value" id="moisture-value">--</div>
        <div class="sensor-status" id="moisture-status">Loading...</div>
      </div>

      <!-- Temperature Sensor -->
      <div class="sensor-card temp-card">
        <div class="sensor-header">
          <div class="sensor-icon">üå°Ô∏è</div>
          <div class="sensor-title">Temperature</div>
        </div>
        <div class="sensor-value" id="temp-value">--</div>
        <div class="sensor-status" id="temp-status">Loading...</div>
      </div>

      <!-- pH Input -->
      <div class="sensor-card ph-card">
        <div class="sensor-header">
          <div class="sensor-icon">üß™</div>
          <div class="sensor-title">pH Level</div>
        </div>
        <input type="number" step="0.1" id="ph-input" class="input-box" placeholder="Enter pH value (e.g. 6.5)">
        <div class="sensor-status" id="ph-status">Waiting for input...</div>
      </div>

      <!-- NPK Input -->
      <div class="sensor-card npk-card">
        <div class="sensor-header">
          <div class="sensor-icon">üß±</div>
          <div class="sensor-title">NPK Levels</div>
        </div>
        <input type="number" id="npk-input" class="input-box" placeholder="Enter NPK value (ppm)">
        <div class="sensor-status" id="npk-status">Waiting for input...</div>
      </div>
    </div>

    <button class="refresh-btn" onclick="updateSensorData()">üîÑ Analyze Soil</button>

    <!-- AI Crop Recommendation -->
    <div class="ai-card">
      <h2>üåæ AI Crop Suggestions</h2>
      <div id="crop-recommendations">
        <p style="color:#7f8c8d; font-style:italic;">Analyzing soil conditions...</p>
      </div>
    </div>
  </div>

  <script>
    async function fetchSensorData() {
      try {
        const response = await fetch("http://localhost:5000/api/sensors");
        if (!response.ok) throw new Error("Network error");
        return await response.json();
      } catch (err) {
        console.error("Error fetching sensor data:", err);
        return null;
      }
    }

    function getStatusInfo(type, value) {
      switch(type) {
        case 'moisture':
          if (value >= 50) return {status:'status-good', text:'Optimal Moisture'};
          if (value >= 30) return {status:'status-warning', text:'Moderate Moisture'};
          return {status:'status-critical', text:'Low Moisture'};
        case 'temperature':
          if (value >= 20 && value <= 25) return {status:'status-good', text:'Ideal Temperature'};
          if (value >= 15 && value <= 30) return {status:'status-warning', text:'Acceptable Range'};
          return {status:'status-critical', text:'Temperature Alert'};
        case 'ph':
          if (value >= 6.0 && value <= 7.5) return {status:'status-good', text:'Optimal pH'};
          if (value >= 5.5 && value <= 8.0) return {status:'status-warning', text:'Acceptable pH'};
          return {status:'status-critical', text:'pH Adjustment Needed'};
        case 'npk':
          if (value >= 150) return {status:'status-good', text:'Rich Nutrients'};
          if (value >= 100) return {status:'status-warning', text:'Moderate Nutrients'};
          return {status:'status-critical', text:'Low Nutrients'};
      }
    }

    async function updateSensorData() {
      const sensorData = await fetchSensorData();
      if (!sensorData) return;

      const phValue = parseFloat(document.getElementById('ph-input').value) || 7.0;
      const npkValue = parseFloat(document.getElementById('npk-input').value) || 120;

      // Update Moisture
      document.getElementById('moisture-value').textContent = sensorData.moisture;
      const mStat = getStatusInfo('moisture', sensorData.moisture);
      document.getElementById('moisture-status').textContent = mStat.text;
      document.getElementById('moisture-status').className = `sensor-status ${mStat.status}`;

      // Update Temperature
      document.getElementById('temp-value').textContent = sensorData.temperature;
      const tStat = getStatusInfo('temperature', sensorData.temperature);
      document.getElementById('temp-status').textContent = tStat.text;
      document.getElementById('temp-status').className = `sensor-status ${tStat.status}`;

      // Update pH
      const phStat = getStatusInfo('ph', phValue);
      document.getElementById('ph-status').textContent = phStat.text;
      document.getElementById('ph-status').className = `sensor-status ${phStat.status}`;

      // Update NPK
      const npkStat = getStatusInfo('npk', npkValue);
      document.getElementById('npk-status').textContent = npkStat.text;
      document.getElementById('npk-status').className = `sensor-status ${npkStat.status}`;

      // Fetch recommendations from backend
      const payload = { 
        moisture: sensorData.moisture, 
        temperature: sensorData.temperature, 
        ph: phValue, 
        npk: npkValue
      };

      try {
        const recResp = await fetch("http://localhost:5000/api/recommendations", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const recJson = await recResp.json();
        const container = document.getElementById("crop-recommendations");
        container.innerHTML = "";

        // Show predicted soil type
        if (recJson.soil_type) {
          const soilDiv = document.createElement("div");
          soilDiv.innerHTML = `<p><strong>Predicted Soil Type:</strong> ${recJson.soil_type}</p>`;
          container.appendChild(soilDiv);
        }

        recJson.recommendations.forEach(crop => {
          const div = document.createElement("div");
          div.className = "recommendation-item";
          div.innerHTML = `<div class="recommendation-title">${crop.name} (${crop.probability})</div>
                           <div class="recommendation-desc">${crop.reason}</div>`;
          container.appendChild(div);
        });

      } catch (err) {
        console.error("Error fetching recommendations:", err);
        document.getElementById("crop-recommendations").innerHTML = 
          "<p style='color:red;'>‚ö†Ô∏è Could not fetch recommendations from server.</p>";
      }
    }

    // Auto-load once
    updateSensorData();
  </script>
</body>
</html>
